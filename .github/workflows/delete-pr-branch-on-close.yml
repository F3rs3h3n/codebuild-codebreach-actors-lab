name: Delete PR Branch on Close

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  delete-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Delete head branch for same-repo PRs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const pr = context.payload.pull_request;
            if (!pr) {
              core.warning("No pull_request payload found; skipping.");
              return;
            }

            const headRef = pr?.head?.ref;
            const headRepoFullName = pr?.head?.repo?.full_name;

            if (!headRef) {
              core.warning(`PR #${pr.number}: missing head ref; cannot delete branch.`);
              return;
            }

            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.default_branch;

            if (headRef === defaultBranch) {
              core.warning(`PR #${pr.number}: head ref is default branch (${defaultBranch}); skipping deletion.`);
              return;
            }

            if (headRepoFullName !== `${owner}/${repo}`) {
              core.info(`PR #${pr.number}: head branch is in a fork (${headRepoFullName}); cannot delete from this repo.`);
              return;
            }

            const ref = `heads/${headRef}`;
            try {
              await github.rest.git.deleteRef({ owner, repo, ref });
              core.info(`PR #${pr.number}: deleted branch ${ref}.`);
            } catch (e) {
              const status = e?.status;
              if (status === 404 || status === 422) {
                core.info(`PR #${pr.number}: branch ${ref} already gone or cannot be deleted (${status}).`);
                return;
              }
              core.warning(`PR #${pr.number}: could not delete ${ref}: ${e.message}`);
            }
